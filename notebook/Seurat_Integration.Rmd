---
title: "440 Project Seurat Integration"
output: html_document
date: "2023-04-07"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{R}
library(Seurat)
library(RColorBrewer)
library(SeuratDisk)
library(SeuratData)
library(Matrix)
library(class)
library(cccd)
library(igraph)
library(slingshot)
library(umap)

#Initializing
set.seed(4202023)
coch.p8.list = list()
coch.p15.list = list()

#Loading Data
for(dir in list.dirs("../data/raw", recursive = FALSE)){
  print(dir)
  p8 = grepl("p8", dir)
  
  count_path = paste0(dir,'/matrix.mtx')
  barcodes_path = paste0(dir,'/barcodes.tsv')
  features_path = paste0(dir,'/features.tsv')
  
  count = Matrix::readMM(count_path)
  barcodes = read.table(barcodes_path)
  features = read.table(features_path)
  group = rep(substring(dir, 13), dim(count)[2])
  
  if(mean(grepl("_", features[,1])) == 1){
    count = count[grepl("mm10___", features[,1]),]
    features = features[grepl("mm10___", features[,1]),]
    features[,1] = substring(features[,1], 8)
    features[,2] = substring(features[,2], 8)
  }
  colnames(count) = barcodes[,1]
  rownames(count) = toupper(features[,2])
  
  rownames(count)[which(duplicated(features[,2]))] = features[which(duplicated(features[,2])),1]
  
  rownames(count)[grepl("^Mt", features[,2])] = features[grepl("^Mt", features[,2]),2]
  


  
  coch = CreateSeuratObject(count)
  group = rep(substring(dir, 13), dim(count)[2])
  coch[["groups"]] = group
  
  cell_filt = (coch$nFeature_RNA >=200)
  gene_filt  = rowSums(count != 0) >=5
  coch = coch[gene_filt, cell_filt]  
  
  
  mt = PercentageFeatureSet(coch, pattern = "^MT-")
  coch[["percent.mt"]] = mt
  print(VlnPlot(coch, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3))
  
  c = GetAssayData(object = coch, slot = "counts")
  
  
  cell_filt = (coch$nFeature_RNA <=5000) & (coch$nFeature_RNA >=750) & (coch$percent.mt <= 30)
  coch = coch[, cell_filt]  
  
  
  coch = NormalizeData(coch)
  coch = FindVariableFeatures(coch, selection.method = "vst", nfeatures = 2000)
  
  coch = list(dir = coch)
  if(p8){
    coch.p8.list = append(coch.p8.list, coch)
    
  }
  else{
    coch.p15.list = append(coch.p15.list, coch)
  }
  print(coch)
}

#Integrating Data
features.p8 = SelectIntegrationFeatures(object.list = coch.p8.list)
features.p15 = SelectIntegrationFeatures(object.list = coch.p15.list)

coch.p8.anchors <- FindIntegrationAnchors(object.list = coch.p8.list, anchor.features = features.p8)
coch.p8 = IntegrateData(anchorset = coch.p8.anchors)

coch.p15.anchors <- FindIntegrationAnchors(object.list = coch.p15.list, anchor.features = features.p15)
coch.p15 = IntegrateData(anchorset = coch.p15.anchors)

#Clustering
set.seed(4202023)
coch.p8 = ScaleData(coch.p8, verbose = FALSE)
coch.p8 = RunPCA(coch.p8)
coch.p8 <- FindNeighbors(coch.p8, dims = 1:50, reduction = "pca", verbose = FALSE)
coch.p8 <- FindClusters(coch.p8, resolution = .4, cluster.name = "unintegrated_clusters", verbose = FALSE)
coch.p8 <- RunUMAP(coch.p8, dims = 1:50, verbose = FALSE)

set.seed(4202023)
coch.p15 = ScaleData(coch.p15, verbose = FALSE)
coch.p15 = RunPCA(coch.p15)
coch.p15 <- FindNeighbors(coch.p15, dims = 1:50, reduction = "pca", verbose = FALSE)
coch.p15 <- FindClusters(coch.p15, resolution = .25, cluster.name = "unintegrated_clusters", verbose = FALSE)
coch.p15 <- RunUMAP(coch.p15, dims = 1:50, verbose = FALSE)


```

```{R}
print(DimPlot(coch.p8, reduction = "umap"))
print(DimPlot(coch.p15, reduction = "umap"))
```

```{R}
for(clust in 0:19){
  print(table(coch.p15[,coch.p15$seurat_clusters == clust][["groups"]]))
}

for(clust in 0:17){
  print(table(coch.p8[,coch.p8$seurat_clusters == clust][["groups"]]))
}
```

```{R}
#find markers
markers.p8 = FindAllMarkers(object = coch.p8)
markers.p15 = FindAllMarkers(object = coch.p15)
```

```{R}
#Label Clusters
#write.csv(markers, '../data/processed/markers.csv')
#write.csv(mono$seurat_clusters, '../data/processed/clusters.csv')

#markers = read.csv('../data/processed/markers.csv')
#char_genes = read.csv('../data/processed/KollaCellClusterGenes.csv')

num_clust = length(levels(coch.p8$seurat_clusters))-1
hits_mat = NULL
for(clust in 0:num_clust){
  hits = c()
  for(cell_type in levels(as.factor(char_genes[,2]))){
    clust_mark = markers.p8[markers.p8[,'cluster'] == clust,'gene']
    ct_filt = char_genes[,2] == cell_type
    ct_mark = char_genes[ct_filt,1]
    matches = match(toupper(ct_mark),toupper(clust_mark))
    hits = c(hits, median(matches[!is.na(matches)]))
    
    #hits = c(hits,length(intersect(toupper(clust_mark), toupper(ct_mark))))
  }
  if(is.null(hits_mat)){
    hits_mat = as.matrix(hits)
  }
  else{
    hits_mat = cbind(hits_mat, hits)
  }
}
rownames(hits_mat) = levels(as.factor(char_genes[,2]))
colnames(hits_mat) = 0:num_clust

hits_mat


```


```{R}
#write.csv(markers, '../data/processed/markers.csv')
#write.csv(mono$seurat_clusters, '../data/processed/clusters.csv')

#markers = read.csv('../data/processed/markers.csv')
char_genes = read.csv('../data/processed/KollaCellClusterGenes.csv')


num_clust = length(levels(coch.p8$seurat_clusters))-1
hits_mat = NULL
for(clust in 0:num_clust){
  hits = c()
  for(cell_type in levels(as.factor(char_genes[,2]))){
    clust_mark = markers.p8[markers.p8[,'cluster'] == clust,'gene'][1:150]
    ct_filt = char_genes[,2] == cell_type
    ct_mark = char_genes[ct_filt,1][1:150]
    hits = c(hits,length(intersect(toupper(clust_mark), toupper(ct_mark))))
  }
  if(is.null(hits_mat)){
    hits_mat = as.matrix(hits)
  }
  else{
    hits_mat = cbind(hits_mat, hits)
  }
}
rownames(hits_mat) = levels(as.factor(char_genes[,2]))
colnames(hits_mat) = 0:num_clust

hits_mat

```


```{R}
#write.csv(markers, '../data/processed/markers.csv')
#write.csv(mono$seurat_clusters, '../data/processed/clusters.csv')

#markers = read.csv('../data/processed/markers.csv')
#char_genes = read.csv('../data/processed/KollaCellClusterGenes.csv')

num_clust = length(levels(coch.p8$seurat_clusters))-1
hits_mat = NULL
for(clust in 0:num_clust){
  hits = c()
  for(cell_type in levels(as.factor(char_genes[,2]))){
    clust_mark = markers.p8[markers.p8[,'cluster'] == clust,'gene']
    ct_filt = char_genes[,2] == cell_type
    ct_mark = char_genes[ct_filt,1]
    matches = match(toupper(ct_mark),toupper(clust_mark))
    hits = c(hits, median(matches[!is.na(matches)]))
    
    #hits = c(hits,length(intersect(toupper(clust_mark), toupper(ct_mark))))
  }
  if(is.null(hits_mat)){
    hits_mat = as.matrix(hits)
  }
  else{
    hits_mat = cbind(hits_mat, hits)
  }
}
rownames(hits_mat) = levels(as.factor(char_genes[,2]))
colnames(hits_mat) = 0:num_clust

hits_mat
```

```{R}
#Label Clusters
#write.csv(markers, '../data/processed/markers.csv')
#write.csv(mono$seurat_clusters, '../data/processed/clusters.csv')

#markers = read.csv('../data/processed/markers.csv')
#char_genes = read.csv('../data/processed/KollaCellClusterGenes.csv')

num_clust = length(levels(coch.p8$seurat_clusters))-1
hits_mat = NULL
for(clust in 0:num_clust){
  hits = c()
  for(cell_type in levels(as.factor(char_genes[,2]))){
    clust_mark = markers.p8[markers.p8[,'cluster'] == clust,'gene']
    ct_filt = char_genes[,2] == cell_type
    ct_mark = char_genes[ct_filt,1]
    matches = match(toupper(ct_mark),toupper(clust_mark))
    hits = c(hits, median(matches[!is.na(matches)]))
    
    #hits = c(hits,length(intersect(toupper(clust_mark), toupper(ct_mark))))
  }
  if(is.null(hits_mat)){
    hits_mat = as.matrix(hits)
  }
  else{
    hits_mat = cbind(hits_mat, hits)
  }
}
rownames(hits_mat) = levels(as.factor(char_genes[,2]))
colnames(hits_mat) = 0:num_clust

hits_mat


```


```{R}
#write.csv(markers, '../data/processed/markers.csv')
#write.csv(mono$seurat_clusters, '../data/processed/clusters.csv')

#markers = read.csv('../data/processed/markers.csv')
char_genes = read.csv('../data/processed/KollaCellClusterGenes.csv')


num_clust = length(levels(coch.p15$seurat_clusters))-1
hits_mat = NULL
for(clust in 0:num_clust){
  hits = c()
  for(cell_type in levels(as.factor(char_genes[,2]))){
    clust_mark = markers.p15[markers.p15[,'cluster'] == clust,'gene'][1:150]
    ct_filt = char_genes[,2] == cell_type
    ct_mark = char_genes[ct_filt,1][1:150]
    hits = c(hits,length(intersect(toupper(clust_mark), toupper(ct_mark))))
  }
  if(is.null(hits_mat)){
    hits_mat = as.matrix(hits)
  }
  else{
    hits_mat = cbind(hits_mat, hits)
  }
}
rownames(hits_mat) = levels(as.factor(char_genes[,2]))
colnames(hits_mat) = 0:num_clust

hits_mat

```


```{R}
#write.csv(markers, '../data/processed/markers.csv')
#write.csv(mono$seurat_clusters, '../data/processed/clusters.csv')

#markers = read.csv('../data/processed/markers.csv')
#char_genes = read.csv('../data/processed/KollaCellClusterGenes.csv')

num_clust = length(levels(coch.p15$seurat_clusters))-1
hits_mat = NULL
for(clust in 0:num_clust){
  hits = c()
  for(cell_type in levels(as.factor(char_genes[,2]))){
    clust_mark = markers.p15[markers.p15[,'cluster'] == clust,'gene']
    ct_filt = char_genes[,2] == cell_type
    ct_mark = char_genes[ct_filt,1]
    matches = match(toupper(ct_mark),toupper(clust_mark))
    hits = c(hits, median(matches[!is.na(matches)]))
    
    #hits = c(hits,length(intersect(toupper(clust_mark), toupper(ct_mark))))
  }
  if(is.null(hits_mat)){
    hits_mat = as.matrix(hits)
  }
  else{
    hits_mat = cbind(hits_mat, hits)
  }
}
rownames(hits_mat) = levels(as.factor(char_genes[,2]))
colnames(hits_mat) = 0:num_clust

hits_mat
```


```{R}
#markers.p15 = FindAllMarkers(object = coch.p15)
#write.csv(markers, '../data/processed/markers.csv')
#write.csv(mono$seurat_clusters, '../data/processed/clusters.csv')

#markers = read.csv('../data/processed/markers.csv')
#char_genes = read.csv('../data/processed/KollaCellClusterGenes.csv')


num_clust = length(levels(coch.p15$seurat_clusters))-1
hits_mat = NULL
for(clust in 0:num_clust){
  hits = c()
  for(cell_type in levels(as.factor(char_genes[,2]))){
    clust_mark = markers.p15[markers.p15[,'cluster'] == clust,'gene'][1:150]
    ct_filt = char_genes[,2] == cell_type
    ct_mark = char_genes[ct_filt,1][1:150]
    hits = c(hits,length(intersect(toupper(clust_mark), toupper(ct_mark))))
  }
  if(is.null(hits_mat)){
    hits_mat = as.matrix(hits)
  }
  else{
    hits_mat = cbind(hits_mat, hits)
  }
}
rownames(hits_mat) = levels(as.factor(char_genes[,2]))
colnames(hits_mat) = 0:num_clust

hits_mat
norm_mat


```
```{R}
for(clust in 0:17){
  print(table(mono[,mono$seurat_clusters == clust][["groups"]]))
}
```

```{R}
DimPlot(mono[,mono$groups == "s9_rosa26GA_p15"], reduction = "umap")
```

```{R}
ct_labels = as.vector(coch.p8$seurat_clusters)
ct_labels[] = "Unclassified"
ct_labels[(coch.p8$seurat_clusters == 0) | (coch.p8$seurat_clusters == 1) | (coch.p8$seurat_clusters == 2) | (coch.p8$seurat_clusters == 3) ] = "Deiters/Pillar/Phalangeal Cells"

ct_labels[(coch.p8$seurat_clusters == 8) | (coch.p8$seurat_clusters == 10)] = "Roof Cells"
ct_labels[(coch.p8$seurat_clusters == 6) | (coch.p8$seurat_clusters == 14)] = "Hair Cells"
ct_labels[(coch.p8$seurat_clusters == 4) | (coch.p8$seurat_clusters == 9)] = "Interdental Cells"
#ct_labels[(coch.p8$seurat_clusters == 7)] = "IPhC"
ct_labels[(coch.p8$seurat_clusters == 17) | (coch.p8$seurat_clusters == 19)] = "Glial Cells"
ct_labels[(coch.p8$seurat_clusters == 5) | (coch.p8$seurat_clusters == 15) | (coch.p8$seurat_clusters == 16)] = "Lateral Greater Epithelial Range (LGER)"
#ct_labels[(coch.p8$seurat_clusters == 5) | (coch.p8$seurat_clusters == 15) | (coch.p8$seurat_clusters == 16)] = "LGER"
#ct_labels[(coch.p8$seurat_clusters == 18)] = "Claudius"


coch.p8[["Annotation"]] = ct_labels
DimPlot(coch.p8, reduction = 'umap',group.by = "Annotation", cols = c("red", "green", "blue", "purple", 
                                                                                     "cyan", "orange","gray"))
ggsave(
  "../fig/coch-p8-umap.png",
  width = 9,
  height = 6,
  dpi = 1200
)
```
```{R}
FeaturePlot(coch.p8[,as.factor(coch.p8$groups) == 'rosa26GAP_p8'], features = "SLC1A3") + ggtitle("GLAST")
ggsave(
  "../fig/GLAST-P8.png",
  width = 6,
  height = 4,
  dpi = 1200
)


FeaturePlot(coch.p15[,as.factor(coch.p15$groups) == 'rosa26GAP_p15'], features = "SLC1A3") + ggtitle("GLAST")
ggsave(
  "../fig/GLAST-P15.png",
  width = 6,
  height = 4,
  dpi = 1200
)
```

```{R}
SaveH5Seurat(coch.p8, "cochlear_p8" ,overwrite = TRUE)
SaveH5Seurat(coch.p15, "cochlear_p15" ,overwrite = TRUE)
```


```{R}
ct_labels = as.vector(coch.p15$seurat_clusters)
ct_labels[] = "Unclassified"
ct_labels[(coch.p15$seurat_clusters == 7) | (coch.p15$seurat_clusters == 4) | (coch.p15$seurat_clusters == 2)] = "Deiters/Pillar/Phalangeal Cells"
ct_labels[(coch.p15$seurat_clusters == 14)] = "Roof Cells"
ct_labels[(coch.p15$seurat_clusters == 11)] = "Hair Cells"
ct_labels[(coch.p15$seurat_clusters == 0)] = "Interdental Cells"
ct_labels[(coch.p15$seurat_clusters == 6)] = "Glial Cells"
ct_labels[(coch.p15$seurat_clusters == 5) | (coch.p15$seurat_clusters == 8) | (coch.p15$seurat_clusters == 17)] = "LGER"
ct_labels[(coch.p15$seurat_clusters == 5) | (coch.p15$seurat_clusters == 8) | (coch.p15$seurat_clusters == 17)] ="Lateral Greater Epithelial Range (LGER)"


coch.p15[["Annotation"]] = ct_labels
DimPlot(coch.p15, reduction = 'umap',group.by = "Annotation", cols = c("red", "green", "blue", "purple", 
                                                                                     "cyan", "orange","gray"))
ggsave(
  "../fig/coch-p15-umap.png",
  width = 9,
  height = 6,
  dpi = 1200
)

```



```{R}
library(slingshot)

pal <- c(RColorBrewer::brewer.pal(9, "Set1"), RColorBrewer::brewer.pal(8, "Set2"))
ct_labels = coch.p8[["Annotation"]]
umap = Embeddings(coch.p8[["umap"]])
for(start in c("Deiters/Pillar/Phalangeal Cells", "Glial Cells", "Interdental Cells", "Lateral Greater Epithelial Range (LGER)", "Roof Cells")){
  filt = as.vector(((ct_labels == start) | (ct_labels == "Hair Cells")) &(as.factor(coch.p8$groups) == 'rosa26GAP_p8'))
  lineages <- getLineages(data = Embeddings(coch.p8, reduction = "pca")[filt,1:50],
                          clusterLabels = ct_labels[filt,],
                          end.clus = "Hair Cells",
                          start.clus = start)
  
  #
  #plot(umap[filt, 1:2], col = pal[as.factor(ct_labels[filt])], cex = 0.5, pch = 16)
  #lines(SlingshotDataSet(lineages), lwd = 3, col = "black")
  
  crv = getCurves(lineages)
  psd_t = slingPseudotime(crv)
  
  colors <- rev(colorRampPalette(brewer.pal(11,'Spectral')[-6])(100))
  plotcol <- colors[cut(psd_t, breaks=100)]
  
  png(paste0(paste0('../fig/Figure4_P8', substr(start,1,5)), '.png'), width = 900, height = 850)
  #layout(matrix(1:2,ncol=2), width = c(2,.75),height = c(1,1))
  legend_image <- as.raster(matrix(rev(colors), ncol=1))
  par(
   mar      = c(8, 8, 5, 5),
   cex.axis = 2.5,
   cex.lab  = 2.5,
   cex.main = 3.5
  )
  plot(umap[filt, 1:2], col = plotcol, cex = 2.5, pch = 16)
  title(start)
  
  dev.off()
  
  png(paste0(paste0('../fig/Legend_P8', substr(start,1,5)), '.png'), width = 900, height = 1200)
  plot(c(0,2),c(0,1),type = 'n', axes = F,xlab = '', ylab = '', main = 'Legend', cex = 3, cex.main =4)
  text(x=1.5, y = seq(0,1,l=3), labels = seq(0,1,l=3), cex = 3)
  rasterImage(legend_image, 0, 0, 1,1)
  dev.off()
  
}
```

```{R}
library(slingshot)

pal <- c(RColorBrewer::brewer.pal(9, "Set1"), RColorBrewer::brewer.pal(8, "Set2"))
ct_labels = coch.p15[["Annotation"]]
umap = Embeddings(coch.p15[["umap"]])
for(start in c("Deiters/Pillar/Phalangeal Cells", "Glia Cells", "Interdental Cells", "Lateral Greater Epithelial Range (LGER)", "Roof Cells")){
  filt = as.vector(((ct_labels == start) | (ct_labels == "Hair Cells")) &(as.factor(coch.p15$groups) == 'rosa26GAP_p15'))
  lineages <- getLineages(data = Embeddings(coch.p15, reduction = "pca")[filt,1:50],
                          clusterLabels = ct_labels[filt,],
                          end.clus = "Hair Cells",
                          start.clus = start)
  
  #plot(umap[filt, 1:2], col = pal[as.factor(ct_labels[filt])], cex = 0.5, pch = 16)
  #lines(SlingshotDataSet(lineages), lwd = 3, col = "black")
  
  crv = getCurves(lineages)
  psd_t = slingPseudotime(crv)
  
  colors <- rev(colorRampPalette(brewer.pal(11,'Spectral')[-6])(100))
  plotcol <- colors[cut(psd_t, breaks=100)]
  
  #png(paste0(paste0('../fig/Figure4_', substr(start,1,5)), '.png'), width  = 500, height = 400)
  # png(paste0(paste0('../fig/Figure4_P15', substr(start,1,5)), '.png'), width = 1200, height = 1100)
  layout(matrix(1:2,ncol=2), width = c(2,.75),height = c(1,1))
  legend_image <- as.raster(matrix(rev(colors), ncol=1))
  #par(
  #  mar      = c(6, 6, 3, 3),
  #  cex.axis = 2.5,
  #  cex.lab  = 2.5,
  #  cex.main = 4
  #)
  plot(umap[filt, 1:2], col = plotcol, cex = 2.5, pch = 16)
  title(start)
  plot(c(0,2),c(0,1),type = 'n', axes = F,xlab = '', ylab = '', main = 'Pseudotime')
  text(x=1.5, y = seq(0,1,l=3), labels = seq(0,1,l=3), cex = 2.5)
  rasterImage(legend_image, 0, 0, 1,1)
  #dev.off()
}
```
```{R}
library(slingshot)

pal <- c(RColorBrewer::brewer.pal(9, "Set1"), RColorBrewer::brewer.pal(8, "Set2"))
ct_labels = coch.p15[["Annotation"]]
umap = Embeddings(coch.p15[["umap"]])
for(start in c("Deiters/Pillar/Phalangeal Cells", "Glia Cells", "Interdental Cells", "Lateral Greater Epithelial Range (LGER)", "Roof Cells")){
  filt = as.vector(((ct_labels == start) | (ct_labels == "Hair Cells")) &(as.factor(coch.p15$groups) == 'rosa26GAP_p15'))
  lineages <- getLineages(data = Embeddings(coch.p15, reduction = "pca")[filt,1:50],
                          clusterLabels = ct_labels[filt,],
                          end.clus = "Hair Cells",
                          start.clus = start)
  
  #
  #plot(umap[filt, 1:2], col = pal[as.factor(ct_labels[filt])], cex = 0.5, pch = 16)
  #lines(SlingshotDataSet(lineages), lwd = 3, col = "black")
  
  crv = getCurves(lineages)
  psd_t = slingPseudotime(crv)
  
  colors <- rev(colorRampPalette(brewer.pal(11,'Spectral')[-6])(100))
  plotcol <- colors[cut(psd_t, breaks=100)]
  
  png(paste0(paste0('../fig/Figure4_P15', substr(start,1,5)), '.png'), width = 900, height = 850)
  #layout(matrix(1:2,ncol=2), width = c(2,.75),height = c(1,1))
  legend_image <- as.raster(matrix(rev(colors), ncol=1))
  par(
   mar      = c(8, 8, 5, 5),
   cex.axis = 2.5,
   cex.lab  = 2.5,
   cex.main = 3.5
  )
  plot(umap[filt, 1:2], col = plotcol, cex = 2.5, pch = 16)
  title(start)
  
  dev.off()
  
  png('../fig/Legend_P15.png', width = 200, height = 300)
  plot(c(0,2),c(0,1),type = 'n', axes = F,xlab = '', ylab = '', main = 'Pseudotime')
  text(x=1.5, y = seq(0,1,l=3), labels = seq(0,1,l=3))
  rasterImage(legend_image, 0, 0, 1,1)
  dev.off()
  
}
```

```{R}
library(limma)
library(org.Mm.eg.db)

tab <- getGeneKEGGLinks(species="mmu")
tab$Symbol <- mapIds(org.Mm.eg.db, tab$GeneID,
                     column="SYMBOL", keytype="ENTREZID")

notch_mm = tab[tab$PathwayID == "mmu04330",]
notch_mm

plot(psd_t, coch.p8[["RNA"]]["SOX9",filt])

vec_pairwise_sub <- function(c,u){
  return(abs(u-c))
}
psd_t <- as.matrix(psd_t)
tt <- apply(psd_t,1,vec_pairwise_sub,kern_avg$x)


colors <- rev(colorRampPalette(brewer.pal(11,'Spectral')[-6])(400))
colors <- rev(viridis(400))
log_col = log(rowSums(tt<1.25))
plotcol <- colors[cut(log_col, breaks=400)]
kern_avg = ksmooth(psd_t, coch.p8[["RNA"]]["SOX9",filt], kernel = "normal", bandwidth = 5)
layout(matrix(1:2,ncol=2), width = c(2,.75),height = c(1,1))
plot(kern_avg$x/max(kern_avg$x),  kern_avg$y, col = plotcol, xlab = 'Pseudotime', ylab = 'SOX9 Expression')
legend_image <- as.raster(matrix(rev(colors), ncol=1))
title("Moving Average Expression")
plot(c(0,2),c(0,1),type = 'n', axes = F,xlab = '', ylab = '', main = 'Log Density', cex.main=.75)
text(x=1.5, y = seq(0,1,l=3), labels = seq(round(min(log_col)),round(max(log_col)),l=3))
rasterImage(legend_image, 0, 0, 1,1)


psd_t <- as.matrix(psd_t)
tt <- apply(psd_t,1,vec_pairwise_sub,kern_avg$x)

colors <- rev(colorRampPalette(brewer.pal(11,'Spectral')[-6])(400))
colors <- rev(viridis(400))
log_col = log(rowSums(tt<1.25))
plotcol <- colors[cut(log_col, breaks=400)]
kern_avg = ksmooth(psd_t, coch.p15[["RNA"]]["SOX9",filt], kernel = "normal", bandwidth = 5)
layout(matrix(1:2,ncol=2), width = c(2,.75),height = c(1,1))
plot(kern_avg$x/max(kern_avg$x),  kern_avg$y, col = plotcol, xlab = 'Pseudotime', ylab = 'SOX9 Expression')
legend_image <- as.raster(matrix(rev(colors), ncol=1))
title("Moving Average Expression")
plot(c(0,2),c(0,1),type = 'n', axes = F,xlab = '', ylab = '', main = 'Log Density', cex.main=.75)
text(x=1.5, y = seq(0,1,l=3), labels = seq(round(min(log_col)),round(max(log_col)),l=3))
rasterImage(legend_image, 0, 0, 1,1)


kern_avg = ksmooth(psd_t, coch.p15[["RNA"]]["NOTCH1",filt], kernel = "normal", bandwidth = 5)
plot(kern_avg$x,  kern_avg$y, type = 'l',)



kern_avg = ksmooth(psd_t, coch.p8[["RNA"]]["NOTCH1",filt], kernel = "normal", bandwidth = 5)
plot(kern_avg$x,  kern_avg$y, col = plotcol)
```
```{R}
coch.p8 = LoadH5Seurat('/Users/lukakarginov/Documents/Classes/20.440/20.440_project/data/processed/cochlear_p8_Annotated.h5seurat')
coch.p15 = LoadH5Seurat('/Users/lukakarginov/Documents/Classes/20.440/20.440_project/data/processed/cochlear_p15_Annotated.h5seurat')
```

```{R}
start = "Deiters/Pillar/Phalangeal Cells"
ct_labels = coch.p8[["Annotation"]]
filt = as.vector(((ct_labels == start) | (ct_labels == "Hair Cells")) &(as.factor(coch.p8$groups) == 'rosa26GAP_p8'))
lineages <- getLineages(data = Embeddings(coch.p8, reduction = "pca")[as.vector(filt)&(as.factor(coch.p8$groups) == 'rosa26GAP_p8'),1:50],
                        clusterLabels = ct_labels[as.vector(filt)&(as.factor(coch.p8$groups) == 'rosa26GAP_p8')],
                        end.clus = "Hair Cells",
                        start.clus = start)

#plot(umap[filt, 1:2], col = pal[as.factor(ct_labels[filt])], cex = 0.5, pch = 16)
#lines(SlingshotDataSet(lineages), lwd = 3, col = "black")

crv = getCurves(lineages)
psd_t = slingPseudotime(crv)
psd_t <- as.matrix(psd_t)

vec_pairwise_sub <- function(c,u){
  return(abs(u-c))
}


for(gene in c("SOX9", "ATOH1", "GFI1", "POU4F3", "NOTCH1", "SLC1A3", "SOX2", "CCND1")){
  kern_avg = ksmooth(psd_t, coch.p8[["RNA"]][gene ,as.vector(filt)&(as.factor(coch.p8$groups) == 'rosa26GAP_p8')], kernel = "normal", bandwidth = 10)
  tt <- apply(psd_t,1,vec_pairwise_sub,kern_avg$x)
  colors <- rev(colorRampPalette(brewer.pal(11,'Spectral')[-6])(400))
  colors <- rev(viridis(400))
  log_col = log(rowSums(tt<2.5))
  
  plotcol <- colors[cut(log_col, breaks=400)]
  layout(matrix(1:2,ncol=2), width = c(2,.75),height = c(1,1))
  plot(kern_avg$x/max(kern_avg$x),  kern_avg$y, col = plotcol, xlab = 'Pseudotime', ylab = paste0(gene, ' Expression'))
  legend_image <- as.raster(matrix(rev(colors), ncol=1))
  title("Moving Average Expression")
  plot(c(0,2),c(0,1),type = 'n', axes = F,xlab = '', ylab = '', main = 'Log Density', cex.main=.75)
  text(x=1.5, y = seq(0,1,l=3), labels = seq(round(min(log_col)),round(max(log_col)),l=3))
  rasterImage(legend_image, 0, 0, 1,1)
}
```

```{R}
start = "Deiters/Pillar/Phalangeal Cells"
ct_labels = coch.p8[["Annotation"]]
filt = as.vector(((ct_labels == start) | (ct_labels == "Hair Cells")) &(as.factor(coch.p8$groups) == 'rosa26GAP_p8'))
lineages <- getLineages(data = Embeddings(coch.p8, reduction = "pca")[filt,1:50],
                        clusterLabels = ct_labels[filt],
                        end.clus = "Hair Cells",
                        start.clus = start)

#plot(umap[filt, 1:2], col = pal[as.factor(ct_labels[filt])], cex = 0.5, pch = 16)
#lines(SlingshotDataSet(lineages), lwd = 3, col = "black")

crv = getCurves(lineages)
psd_t = slingPseudotime(crv)
psd_t <- as.matrix(psd_t)



 #"SLC1A3", "SOX2", "PROX1"
for(gene in c("ATOH1", "GFI1", "POU4F3", "NOTCH1")){
  kern_avg = ksmooth(psd_t, coch.p8[["RNA"]][gene ,as.vector(filt)], kernel = "normal", bandwidth = 10)
  tt <- apply(psd_t,1,vec_pairwise_sub,kern_avg$x)
  colors <- rev(colorRampPalette(brewer.pal(11,'Spectral')[-6])(400))
  colors <- rev(viridis(400))
  log_col = log(rowSums(tt<2.5))
  
  plotcol <- colors[cut(log_col, breaks=400)]
  #layout(matrix(1:2,ncol=2), width = c(2,.75),height = c(1,1))
  png(paste0(paste0('../fig/P8_', gene), '.png'), width = 1200, height = 1100)
   par(
    mar      = c(6, 6, 3, 3),
    cex.axis = 2.5,
    cex.lab  = 2.5,
    cex.main = 4
  )
  plot(kern_avg$x/max(kern_avg$x),  kern_avg$y, col = plotcol, xlab = 'Pseudotime', ylab = paste0(gene, ' Expression'), cex = 3)
  legend_image <- as.raster(matrix(rev(colors), ncol=1))
  title("Moving Average")
  dev.off()
  
  png('../fig/P8_legend.png')
  plot(c(0,2),c(0,1),type = 'n', axes = F,xlab = '', ylab = '', main = 'Log Density')
  text(x=1.5, y = seq(0,1,l=3), labels = seq(round(min(log_col)),round(max(log_col)),l=3))
  rasterImage(legend_image, 0, 0, 1,1)
  dev.off()
}
```

```{R}
start = "Deiters/Pillar/Phalangeal Cells"
ct_labels = coch.p8[["Annotation"]]
filt = as.vector(((ct_labels == start) | (ct_labels == "Hair Cells")) &(as.factor(coch.p8$groups) == 'rosa26A_p8'))
lineages <- getLineages(data = Embeddings(coch.p8, reduction = "pca")[filt,1:50],
                        clusterLabels = ct_labels[filt,],
                        end.clus = "Hair Cells",
                        start.clus = start)

#plot(umap[filt, 1:2], col = pal[as.factor(ct_labels[filt])], cex = 0.5, pch = 16)
#lines(SlingshotDataSet(lineages), lwd = 3, col = "black")

crv = getCurves(lineages)
psd_t = slingPseudotime(crv)
psd_t <- as.matrix(psd_t)


png('../fig/TFs_P8.png', width = 900, height = 850)
par(
  mar      = c(8, 8, 5, 5),
  cex.axis = 2.5,
  cex.lab  = 2.5,
  cex.main = 3.5
)
plot(NULL, NULL,xlim = c(0,1), ylim = c(0,2.5), ylab = "Expression", xlab = "Pseudotime" )
colors = c("black", "red", "blue")
color_num = 1
for(gene in c("ATOH1", "GFI1", "POU4F3")){
  kern_avg = ksmooth(psd_t, coch.p8[["RNA"]][gene ,as.vector(filt)], kernel = "normal", bandwidth = 10)
  #tt <- apply(psd_t,1,vec_pairwise_sub,kern_avg$x)
  #colors <- rev(colorRampPalette(brewer.pal(11,'Spectral')[-6])(400))
  #colors <- rev(viridis(400))
  #log_col = log(rowSums(tt<2.5))
  lines(kern_avg$x/max(kern_avg$x),  kern_avg$y, xlab = 'Pseudotime', ylab = paste0(gene, ' Expression'), cex = 3, col = colors[color_num], lwd = 4.0) 
  color_num= color_num+1
}
legend('topleft', legend = c("ATOH1", "GFI1", "POU4F3"), col = colors, lty = 1, cex = 2.5, lwd = 4)
dev.off()


png('../fig/NOTCH1_P8.png', width = 900, height = 850)
par(
  mar      = c(8, 8, 5, 5),
  cex.axis = 2.5,
  cex.lab  = 2.5,
  cex.main = 3.5
)
plot(NULL, NULL,xlim = c(0,1), ylim = c(0,1.5), ylab = "NOTCH1 Expression", xlab = "Pseudotime" )
colors = c("black")
color_num = 1
for(gene in c("NOTCH1")){
  kern_avg = ksmooth(psd_t, coch.p8[["RNA"]][gene ,as.vector(filt)], kernel = "normal", bandwidth = 10)
  #tt <- apply(psd_t,1,vec_pairwise_sub,kern_avg$x)
  #colors <- rev(colorRampPalette(brewer.pal(11,'Spectral')[-6])(400))
  #colors <- rev(viridis(400))
  #log_col = log(rowSums(tt<2.5))
  
  #plotcol <- colors[cut(log_col, breaks=400)]
  #layout(matrix(1:2,ncol=2), width = c(2,.75),height = c(1,1))

  lines(kern_avg$x/max(kern_avg$x),  kern_avg$y, xlab = 'Pseudotime', ylab = paste0(gene, ' Expression'), cex = 3, col = colors[color_num],lwd = 4.0) 
  #legend_image <- as.raster(matrix(rev(colors), ncol=1))
  
  #png('../fig/P8_legend.png')
  #plot(c(0,2),c(0,1),type = 'n', axes = F,xlab = '', ylab = '', main = 'Log Density')
  #text(x=1.5, y = seq(0,1,l=3), labels = seq(round(min(log_col)),round(max(log_col)),l=3))
  #rasterImage(legend_image, 0, 0, 1,1)
  #dev.off()
  color_num= color_num+1
}
dev.off()

png('../fig/Cell_density8.png', width = 900, height = 850)
par(
  mar      = c(6, 6, 3, 3),
  cex.axis = 2.5,
  cex.lab  = 2.5,
  cex.main = 4
)
tt <- apply(psd_t,1,vec_pairwise_sub,kern_avg$x)
log_col = log(rowSums(tt<2.5))
plot(kern_avg$x/max(kern_avg$x), log_col, xlab = "Pseudotime", ylab = "Log Cell Density", type = "l", lwd = 2, ylim = c(0,7.5))

```

```{R}
start = "Deiters/Pillar/Phalangeal Cells"
ct_labels = coch.p15[["Annotation"]]
filt = (ct_labels == start) | (ct_labels == "Hair Cells")
lineages <- getLineages(data = Embeddings(coch.p15, reduction = "pca")[as.vector(filt)&(as.factor(coch.p15$groups) == 'rosa26GAP_p15'),1:50],
                        clusterLabels = ct_labels[as.vector(filt)&(as.factor(coch.p15$groups) == 'rosa26GAP_p15'),],
                        end.clus = "Hair Cells",
                        start.clus = start)

#plot(umap[filt, 1:2], col = pal[as.factor(ct_labels[filt])], cex = 0.5, pch = 16)
#lines(SlingshotDataSet(lineages), lwd = 3, col = "black")

crv = getCurves(lineages)
psd_t = slingPseudotime(crv)
psd_t <- as.matrix(psd_t)



for(gene in c("SOX9", "ATOH1", "GFI1", "POU4F3", "NOTCH1", "SLC1A3", "SOX2", "CCND1")){
  kern_avg = ksmooth(psd_t, coch.p15[["RNA"]][gene ,as.vector(filt)&(as.factor(coch.p15$groups) == 'rosa26GAP_p15')], kernel = "normal", bandwidth = 10)
  tt <- apply(psd_t,1,vec_pairwise_sub,kern_avg$x)
  colors <- rev(colorRampPalette(brewer.pal(11,'Spectral')[-6])(400))
  colors <- rev(viridis(400))
  log_col = log(rowSums(tt<2.5)+1)
  
  plotcol <- colors[cut(log_col, breaks=400)]
  layout(matrix(1:2,ncol=2), width = c(2,.75),height = c(1,1))
  plot(kern_avg$x/max(kern_avg$x),  kern_avg$y, col = plotcol, xlab = 'Pseudotime', ylab = paste0(gene, ' Expression'))
  legend_image <- as.raster(matrix(rev(colors), ncol=1))
  title("Moving Average Expression")
  plot(c(0,2),c(0,1),type = 'n', axes = F,xlab = '', ylab = '', main = 'Log Density', cex.main=.75)
  text(x=1.5, y = seq(0,1,l=3), labels = seq(round(min(log_col)),round(max(log_col)),l=3))
  rasterImage(legend_image, 0, 0, 1,1)
}
```

```{R}
start = "Deiters/Pillar/Phalangeal Cells"
ct_labels = coch.p15[["Annotation"]]
filt = as.vector(((ct_labels == start) | (ct_labels == "Hair Cells")) &(as.factor(coch.p15$groups) == 'rosa26GAP_p15'))
lineages <- getLineages(data = Embeddings(coch.p15, reduction = "pca")[filt,1:50],
                        clusterLabels = ct_labels[filt,],
                        end.clus = "Hair Cells",
                        start.clus = start)

#plot(umap[filt, 1:2], col = pal[as.factor(ct_labels[filt])], cex = 0.5, pch = 16)
#lines(SlingshotDataSet(lineages), lwd = 3, col = "black")

crv = getCurves(lineages)
psd_t = slingPseudotime(crv)
psd_t <- as.matrix(psd_t)


png('../fig/TFs_P15.png', width = 900, height = 850)
par(
  mar      = c(8, 8, 5, 5),
  cex.axis = 2.5,
  cex.lab  = 2.5,
  cex.main = 3.5
)
plot(NULL, NULL,xlim = c(0,1), ylim = c(0,2.5), ylab = "Expression", xlab = "Pseudotime" )
colors = c("black", "red", "blue")
color_num = 1
for(gene in c("ATOH1", "GFI1", "POU4F3")){
  kern_avg = ksmooth(psd_t, coch.p15[["RNA"]][gene ,as.vector(filt)], kernel = "normal", bandwidth = 10)
  #tt <- apply(psd_t,1,vec_pairwise_sub,kern_avg$x)
  #colors <- rev(colorRampPalette(brewer.pal(11,'Spectral')[-6])(400))
  #colors <- rev(viridis(400))
  #log_col = log(rowSums(tt<2.5))
  lines(kern_avg$x/max(kern_avg$x),  kern_avg$y, xlab = 'Pseudotime', ylab = paste0(gene, ' Expression'), cex = 3, col = colors[color_num], lwd = 4.0) 
  color_num= color_num+1
}
legend('topleft', legend = c("ATOH1", "GFI1", "POU4F3"), col = colors, lty = 1, cex = 2.5, lwd = 4)
dev.off()


png('../fig/NOTCH1_P15.png', width = 900, height = 850)
par(
  mar      = c(8, 8, 5, 5),
  cex.axis = 2.5,
  cex.lab  = 2.5,
  cex.main = 3.5
)
plot(NULL, NULL,xlim = c(0,1), ylim = c(0,1.5), ylab = "NOTCH1 Expression", xlab = "Pseudotime" )
colors = c("black")
color_num = 1
for(gene in c("NOTCH1")){
  kern_avg = ksmooth(psd_t, coch.p15[["RNA"]][gene ,as.vector(filt)], kernel = "normal", bandwidth = 10)
 
  
  #plotcol <- colors[cut(log_col, breaks=400)]
  #layout(matrix(1:2,ncol=2), width = c(2,.75),height = c(1,1))

  lines(kern_avg$x/max(kern_avg$x),  kern_avg$y, xlab = 'Pseudotime', ylab = paste0(gene, ' Expression'), cex = 3, col = colors[color_num], lwd = 4.0) 
  #legend_image <- as.raster(matrix(rev(colors), ncol=1))
  
  #png('../fig/P8_legend.png')
  #plot(c(0,2),c(0,1),type = 'n', axes = F,xlab = '', ylab = '', main = 'Log Density')
  #text(x=1.5, y = seq(0,1,l=3), labels = seq(round(min(log_col)),round(max(log_col)),l=3))
  #rasterImage(legend_image, 0, 0, 1,1)
  #dev.off()
  color_num= color_num+1
}
dev.off()

png('../fig/Cell_density15.png', width = 900, height = 850)
par(
  mar      = c(6, 6, 3, 3),
  cex.axis = 2.5,
  cex.lab  = 2.5,
  cex.main = 4
)
tt <- apply(psd_t,1,vec_pairwise_sub,kern_avg$x)
log_col = log(rowSums(tt<2.5))
plot(kern_avg$x/max(kern_avg$x), log_col, xlab = "Pseudotime", ylab = "Log Cell Density", type = "l", lwd = 2)

```

```{R}
pal <- c(RColorBrewer::brewer.pal(9, "Set1"), RColorBrewer::brewer.pal(8, "Set2"))
ct_labels = coch.p8[["Annotation"]]
umap = Embeddings(coch.p8[["umap"]])
for(start in c("Deiters/Pillar/Phalangeal Cells", "Glia Cells", "Interdental Cells", "Lateral Greater Epithelial Range (LGER)", "Roof Cells")){
  filt = as.vector(((ct_labels == start) | (ct_labels == "Hair Cells")) &(as.factor(coch.p8$groups) == 'rosa26GAP_p8'))
  lineages <- getLineages(data = Embeddings(coch.p8, reduction = "pca")[filt,1:50],
                          clusterLabels = ct_labels[filt,],
                          end.clus = "Hair Cells",
                          start.clus = start)
  
  #
  #plot(umap[filt, 1:2], col = pal[as.factor(ct_labels[filt])], cex = 0.5, pch = 16)
  #lines(SlingshotDataSet(lineages), lwd = 3, col = "black")
  
  crv = getCurves(lineages)
  psd_t = slingPseudotime(crv)
  psd_t <- as.matrix(psd_t)

  gene = "SOX9"
  kern_avg = ksmooth(psd_t, coch.p8[["RNA"]][gene ,as.vector(filt)&(as.factor(coch.p8$groups) == 'rosa26GAP_p8')], kernel = "normal", bandwidth = 10)
  tt <- apply(psd_t,1,vec_pairwise_sub,kern_avg$x)
  colors <- rev(colorRampPalette(brewer.pal(11,'Spectral')[-6])(400))
  colors <- rev(viridis(400))
  log_col = log(rowSums(tt<2.5)+1)
  
  plotcol <- colors[cut(log_col, breaks=400)]
  png(paste0(paste0('../fig/SOX9_', substring(start,1,5)), '.png'), width = 1200, height = 1100)
   par(
    mar      = c(7, 7, 4, 4),
    cex.axis = 3,
    cex.lab  = 3,
    cex.main = 4.5
  )
  plot(kern_avg$x/max(kern_avg$x),  kern_avg$y, col = plotcol, xlab = 'Pseudotime', ylab = paste0("Average ",paste0(gene, ' Expression')), cex = 3, pch = 19)
  legend_image <- as.raster(matrix(rev(colors), ncol=1))
  if( start == "Lateral Greater Epithelial Range (LGER)"){
    start = "LGER"
  }
  title(start)
  dev.off()
  
  
  
  png(paste0(paste0('../fig/P8_legend_',substring(start,1,4)),'.png'), width = 600, height =1200)
  par(
    mar      = c(6, 6, 3, 3),
    cex.axis = 2.5,
    cex.lab  = 2.5,
    cex.main = 4
  )
  plot(c(0,2),c(0,1),type = 'n', axes = F,xlab = '', ylab = '', main = 'Log Cell Density')
  text(x=1.5, y = seq(0,1,l=3), labels = seq(round(min(log_col)),round(max(log_col)),l=3), cex = 4)
  rasterImage(legend_image, 0, 0, 1,1)
  dev.off()
  
}
```

```{R}
pal <- c(RColorBrewer::brewer.pal(9, "Set1"), RColorBrewer::brewer.pal(8, "Set2"))
ct_labels = coch.p15[["Annotation"]]
umap = Embeddings(coch.p15[["umap"]])
for(start in c("Deiters/Pillar/Phalangeal Cells", "Glia Cells", "Interdental Cells", "Lateral Greater Epithelial Range (LGER)", "Roof Cells")){
  filt = as.vector(((ct_labels == start) | (ct_labels == "Hair Cells")) &(as.factor(coch.p15$groups) == 'rosa26GAP_p15'))
  lineages <- getLineages(data = Embeddings(coch.p15, reduction = "pca")[filt,1:50],
                          clusterLabels = ct_labels[filt,],
                          end.clus = "Hair Cells",
                          start.clus = start)
  
  #
  #plot(umap[filt, 1:2], col = pal[as.factor(ct_labels[filt])], cex = 0.5, pch = 16)
  #lines(SlingshotDataSet(lineages), lwd = 3, col = "black")
  
  crv = getCurves(lineages)
  psd_t = slingPseudotime(crv)
  psd_t <- as.matrix(psd_t)

  gene = "SOX9"
  kern_avg = ksmooth(psd_t, coch.p15[["RNA"]][gene ,as.vector(filt)&(as.factor(coch.p15$groups) == 'rosa26GAP_p15')], kernel = "normal", bandwidth = 10)
  tt <- apply(psd_t,1,vec_pairwise_sub,kern_avg$x)
  colors <- rev(colorRampPalette(brewer.pal(11,'Spectral')[-6])(400))
  colors <- rev(viridis(400))
  log_col = log(rowSums(tt<2.5)+1)
  
  plotcol <- colors[cut(log_col, breaks=400)]
  png(paste0(paste0('../fig/P15_SOX9_', substring(start,1,5)), '.png'), width = 1200, height = 1100)
   par(
    mar      = c(7, 7, 4, 4),
    cex.axis = 3,
    cex.lab  = 3,
    cex.main = 4.5
  )
  plot(kern_avg$x/max(kern_avg$x),  kern_avg$y, col = plotcol, xlab = 'Pseudotime', ylab = paste0("Average ",paste0(gene, ' Expression')), cex = 3, pch = 19)
  legend_image <- as.raster(matrix(rev(colors), ncol=1))
  if( start == "Lateral Greater Epithelial Range (LGER)"){
    start = "LGER"
  }
  title(start)
  dev.off()
  
  
  png(paste0(paste0('../fig/P15_legend_',substring(start,1,4)),'.png'), width = 600, height =1200)
  par(
    mar      = c(6, 6, 3, 3),
    cex.axis = 2.5,
    cex.lab  = 2.5,
    cex.main = 4
  )
  plot(c(0,2),c(0,1),type = 'n', axes = F,xlab = '', ylab = '', main = 'Log Cell Density')
  text(x=1.5, y = seq(0,1,l=3), labels = seq(round(min(log_col)),round(max(log_col)),l=3), cex = 4)
  rasterImage(legend_image, 0, 0, 1,1)
  dev.off()
  
}
```



```{R}
start = "Deiters/Pillar/Phalangeal Cells"
filt = (ct_labels == start) | (ct_labels == "Hair Cells")
lineages <- getLineages(data = Embeddings(coch.p8, reduction = "pca")[filt,1:50],
                        clusterLabels = ct_labels[filt],
                        end.clus = "Hair Cells",
                        start.clus = start)

#plot(umap[filt, 1:2], col = pal[as.factor(ct_labels[filt])], cex = 0.5, pch = 16)
#lines(SlingshotDataSet(lineages), lwd = 3, col = "black")

crv = getCurves(lineages)
psd_t = slingPseudotime(crv)
psd_t <- as.matrix(psd_t)
tt <- apply(psd_t,1,vec_pairwise_sub,kern_avg$x)




png('../fig/Figure4_P8_SOX9.png', width = 1100, height = 1000)
par(
    mar      = c(10, 10, 5, 5)
  )
colors <- rev(colorRampPalette(brewer.pal(11,'Spectral')[-6])(400))
colors <- rev(viridis(400))
log_col = log(rowSums(tt<1.25))
plotcol <- colors[cut(log_col, breaks=400)]
kern_avg = ksmooth(psd_t, coch.p8[["RNA"]]["SOX9",filt], kernel = "normal", bandwidth = 10)
#layout(matrix(1:2,ncol=2), width = c(2,.75),height = c(1,1))
plot(kern_avg$x/max(kern_avg$x),  kern_avg$y, col = plotcol, xlab = 'Pseudotime', ylab = 'SOX9 Expression', cex = 3, cex.lab  = 3, cex.axis = 3)
#legend_image <- as.raster(matrix(rev(colors), ncol=1))
title("Moving Average Expression", cex.main = 4)
```

```{R}
start = "Deiters/Pillar/Phalangeal Cells"

filt = (ct_labels == start) | (ct_labels == "Hair Cells")
lineages <- getLineages(data = Embeddings(coch.p15, reduction = "pca")[filt,1:50],
                        clusterLabels = ct_labels[filt],
                        end.clus = "Hair Cells",
                        start.clus = start)

#plot(umap[filt, 1:2], col = pal[as.factor(ct_labels[filt])], cex = 0.5, pch = 16)
#lines(SlingshotDataSet(lineages), lwd = 3, col = "black")

crv = getCurves(lineages)
psd_t = slingPseudotime(crv)
psd_t <- as.matrix(psd_t)
tt <- apply(psd_t,1,vec_pairwise_sub,kern_avg$x)




#png('../fig/Figure4_P15_SOX9.png', width = 1100, height = 1000)
#par(
#    mar      = c(10, 10, 5, 5)
#  )
colors <- rev(colorRampPalette(brewer.pal(11,'Spectral')[-6])(400))
colors <- rev(viridis(400))
log_col = log(rowSums(tt<1.25))
plotcol <- colors[cut(log_col, breaks=400)]
kern_avg = ksmooth(psd_t, coch.p15[["RNA"]]["SOX9",filt], kernel = "normal", bandwidth = 5)
layout(matrix(1:2,ncol=2), width = c(2,.75),height = c(1,1))
plot(kern_avg$x/max(kern_avg$x),  kern_avg$y, col = plotcol, xlab = 'Pseudotime', ylab = 'SOX9 Expression')#, cex = 3, cex.lab  = 3, cex.axis = 3)
legend_image <- as.raster(matrix(rev(colors), ncol=1))
title("Moving Average Expression")#, cex.main = 4)
plot(c(0,2),c(0,1),type = 'n', axes = F,xlab = '', ylab = '', main = 'Log Density')#, cex.main=1)
text(x=1.5, y = seq(0,1,l=3), labels = seq(round(min(log_col)),round(max(log_col)),l=3))#, cex = 1)
rasterImage(legend_image, 0, 0, 1,1)
```





```{R}
dirs = list.dirs("../data/raw", recursive = FALSE)
counts = NULL
grps = NULL

for(dir in list.dirs("../data/raw", recursive = FALSE)){
  print(dir)
  
  count_path = paste0(dir,'/matrix.mtx')
  barcodes_path = paste0(dir,'/barcodes.tsv')
  features_path = paste0(dir,'/features.tsv')
  
  count = Matrix::readMM(count_path)
  barcodes = read.table(barcodes_path)
  features = read.table(features_path)
  group = rep(substring(dir, 13), dim(count)[2])
  
  if(mean(grepl("_", features[,1])) == 1){
    count = count[grepl("mm10___", features[,1]),]
    features = features[grepl("mm10___", features[,1]),]
    features[,1] = substring(features[,1], 8)
    features[,2] = substring(features[,2], 8)
  }
  
  colnames(count) = barcodes[,1]
  rownames(count) = toupper(features[,2])
  
  rownames(count)[which(duplicated(features[,2]))] = features[which(duplicated(features[,2])),1]
  
  if (is.null(counts)){
    counts = count
    grps = group
  }
  else{
    counts = cbind(counts, count)
    grps = c(grps, group)
  }
}
  
rownames(counts)[grepl("^Mt", features[,2])] = features[grepl("^Mt", features[,2]),2]
mono = CreateSeuratObject(counts)
mono[["groups"]] = grps

cell_filt = (mono$nFeature_RNA >=200)
gene_filt  = rowSums(count != 0) >=5
mono = mono[gene_filt, cell_filt]  


mt = PercentageFeatureSet(mono, pattern = "^MT-")
mono[["percent.mt"]] = mt
VlnPlot(mono, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

c = GetAssayData(object = mono, slot = "counts")


cell_filt = (mono$nFeature_RNA <=5000) & (mono$nFeature_RNA >=750) & (mono$percent.mt <= 30)
mono = mono[, cell_filt]  

mono = NormalizeData(mono, verbose = FALSE)
mono = FindVariableFeatures(mono, verbose = FALSE)
mono = ScaleData(mono, verbose = FALSE)
mono = RunPCA(mono, verbose = FALSE)

mono <- FindNeighbors(mono, dims = 1:10, reduction = "pca", verbose = FALSE)
mono <- FindClusters(mono, resolution = .25, cluster.name = "unintegrated_clusters", verbose = FALSE)

mono <- RunUMAP(mono, dims = 1:10, verbose = FALSE)
print(DimPlot(mono, reduction = "umap"))

print(DimPlot(mono[,mono$groups == "s9_rosa26GA_p15"], reduction = "umap"))
```

```{R}
dir = dirs[1]

count_path = paste0(dir,'/matrix.mtx')
barcodes_path = paste0(dir,'/barcodes.tsv')
features_path = paste0(dir,'/features.tsv')

count = Matrix::readMM(count_path)
barcodes = read.table(barcodes_path)
features = read.table(features_path)

if(mean(grepl("_", features[,1])) == 1){
  features[,1] = substring(features[,1], 8)
}

if(mean(grepl("_", features[,2])) == 1){
  features[,2] = substring(features[,2], 8)
}

colnames(count) = barcodes[,1]
rownames(count) = toupper(features[,2])

rownames(count)[which(duplicated(features[,2]))] = features[which(duplicated(features[,2])),1]

mono = CreateSeuratObject(count)
dim(mono)
```

```{R}
mt = PercentageFeatureSet(mono, pattern = "^MT-")
mono[["percent.mt"]] = mt
VlnPlot(mono, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

c = GetAssayData(object = mono, slot = "counts")


gene_filt  = rowSums(c != 0) >=5

cell_filt = (mono$nFeature_RNA <=5000) & (mono$nFeature_RNA >=750) & (mono$percent.mt <= 30)
mono = mono[gene_filt, cell_filt]
```

```{R}
mono = NormalizeData(mono)
mono = FindVariableFeatures(mono)
mono = ScaleData(mono)


mono = RunPCA(mono)
ElbowPlot(mono)


mono <- FindNeighbors(mono, dims = 1:10, reduction = "pca")
mono <- FindClusters(mono, resolution = .25, cluster.name = "unintegrated_clusters")
```

```{R}
mono <- RunUMAP(mono, dims = 1:10)
DimPlot(mono, reduction = "umap")


```

```{R}
graph = nng(mono[["pca"]][,1:10],k = 10)
graph = as.undirected(graph, mode = "collapse")
mono.clust = cluster_louvain(graph)
mono_umap = umap(mono[["pca"]][,1:10])
plot(mono_umap$layout[,1],mono_umap$layout[,2], col = mono.clust$membership)
legend('bottomright', legend = levels(as.factor(mono.clust$membership)), col = levels(as.factor(mono.clust$membership)), pch = 1)
```

